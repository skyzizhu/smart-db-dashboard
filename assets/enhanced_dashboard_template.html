<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{TITLE}}</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px; padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-left h1 { color: #333; font-size: 24px; font-weight: 600; margin-bottom: 5px; }
        .header-left p { color: #666; font-size: 14px; }
        .meta-info {
            text-align: right; color: #666; font-size: 12px;
        }
        .meta-info div { margin: 3px 0; }

        /* ÁªüËÆ°Âç°Áâá */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px; margin-bottom: 20px;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px; padding: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .stat-label { color: #666; font-size: 14px; margin-bottom: 8px; }
        .stat-value { font-size: 32px; font-weight: 700; color: #667eea; }
        .stat-change {
            font-size: 12px; margin-top: 8px;
        }
        .stat-change.up { color: #10b981; }
        .stat-change.down { color: #ef4444; }

        /* ÂõæË°®ÂÆπÂô® */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px; margin-bottom: 20px;
        }
        .chart-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px; padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .chart-card h3 {
            color: #333; font-size: 16px; font-weight: 600;
            margin-bottom: 15px; padding-bottom: 10px;
            border-bottom: 2px solid #f0f2f5;
        }
        .chart-container { position: relative; height: 300px; }

        /* Êï∞ÊçÆË°®Ê†º */
        .data-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px; padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .data-card h3 {
            color: #333; font-size: 18px; font-weight: 600;
            margin-bottom: 15px; padding-bottom: 10px;
            border-bottom: 2px solid #f0f2f5;
        }
        .table-wrapper { overflow-x: auto; }
        .data-table {
            width: 100%; border-collapse: collapse;
        }
        .data-table th, .data-table td {
            padding: 12px 14px; text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }
        .data-table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            font-weight: 600; color: #495057;
            white-space: nowrap;
        }
        .data-table tr:hover { background: #f8f9fa; }
        .data-table tr:nth-child(even) { background: #fafbfc; }

        /* ÂàÜÈ°µ */
        .pagination {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 20px; padding-top: 15px;
            border-top: 2px solid #f0f2f5;
        }
        .page-info { color: #666; font-size: 14px; }
        .page-controls { display: flex; gap: 8px; }
        .page-btn {
            padding: 8px 14px; border: 2px solid #e1e5e9;
            background: white; border-radius: 6px;
            cursor: pointer; transition: all 0.3s ease;
            font-size: 13px; color: #495057;
        }
        .page-btn:hover:not(:disabled) {
            border-color: #667eea; color: #667eea;
        }
        .page-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border-color: transparent;
        }
        .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }

        /* ÂæΩÁ´† */
        .badge {
            display: inline-block; padding: 4px 10px;
            border-radius: 12px; font-size: 12px; font-weight: 500;
        }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        .badge-warning { background: #fef3c7; color: #92400e; }

        /* ÂìçÂ∫îÂºè */
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .charts-section { grid-template-columns: 1fr; }
            .header { flex-direction: column; text-align: center; }
            .meta-info { text-align: center; margin-top: 15px; }
        }

        /* Âä†ËΩΩÂä®Áîª */
        .loading { text-align: center; padding: 60px 20px; color: #666; }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #667eea;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Â§¥ÈÉ® -->
        <div class="header">
            <div class="header-left">
                <h1>{{QUERY_TITLE}}</h1>
                <p>{{QUERY_DESCRIPTION}}</p>
            </div>
            <div class="meta-info">
                <div>üìÖ ÁîüÊàêÊó∂Èó¥: {{GENERATED_TIME}}</div>
                <div>‚è±Ô∏è Êü•ËØ¢ËÄóÊó∂: {{QUERY_TIME}}</div>
                <div>üìä Êï∞ÊçÆÈáè: {{ROW_COUNT}} Êù°</div>
            </div>
        </div>

        <!-- ÁªüËÆ°Âç°Áâá -->
        <div class="stats-grid" id="statsContainer">
            <!-- Âä®ÊÄÅÊèíÂÖ•ÁªüËÆ°Âç°Áâá -->
        </div>

        <!-- ÂõæË°®Âå∫Âüü -->
        <div class="charts-section" id="chartsContainer">
            <!-- Âä®ÊÄÅÊèíÂÖ•ÂõæË°® -->
        </div>

        <!-- Êï∞ÊçÆË°®Ê†º -->
        <div class="data-card" id="dataCard">
            <h3>üìã Êï∞ÊçÆÊòéÁªÜ</h3>
            <div class="table-wrapper">
                <table class="data-table" id="dataTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <div class="pagination" id="pagination" style="display: none;">
                <div class="page-info" id="pageInfo"></div>
                <div class="page-controls" id="pageControls"></div>
            </div>
        </div>
    </div>

    <script>
        // Êï∞ÊçÆÊ≥®ÂÖ•
        window.dashboardData = {{DATA_JSON}};

        // ÈÖçÁΩÆ
        let currentPage = 1;
        const pageSize = 20;
        let totalRecords = 0;
        let filteredData = [];

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initDashboard();
        });

        function initDashboard() {
            const data = window.dashboardData;

            if (!data || !data.success) {
                showError(data?.error || 'Âä†ËΩΩÂ§±Ë¥•');
                return;
            }

            totalRecords = data.row_count || 0;
            filteredData = data.data || [];

            // Ê∏≤ÊüìÂêÑ‰∏™ÈÉ®ÂàÜ
            renderStats(data.stats || {});
            renderCharts(data.charts || []);
            renderTable(data.columns || [], filteredData);
        }

        function renderStats(stats) {
            const container = document.getElementById('statsContainer');
            container.innerHTML = '';

            const statsList = stats.list || [];

            statsList.forEach(stat => {
                const card = document.createElement('div');
                card.className = 'stat-card';
                card.innerHTML = `
                    <div class="stat-label">${stat.label}</div>
                    <div class="stat-value">${stat.value}</div>
                    ${stat.change ? `<div class="stat-change ${stat.change >= 0 ? 'up' : 'down'}">
                        ${stat.change >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(stat.change)}%
                    </div>` : ''}
                `;
                container.appendChild(card);
            });
        }

        function renderCharts(charts) {
            const container = document.getElementById('chartsContainer');
            container.innerHTML = '';

            if (charts.length === 0) {
                container.style.display = 'none';
                return;
            }

            charts.forEach((chartConfig, index) => {
                const card = document.createElement('div');
                card.className = 'chart-card';
                card.innerHTML = `
                    <h3>${chartConfig.title}</h3>
                    <div class="chart-container">
                        <canvas id="chart${index}"></canvas>
                    </div>
                `;
                container.appendChild(card);

                // ÂàõÂª∫ÂõæË°®
                createChart(`chart${index}`, chartConfig);
            });
        }

        function createChart(canvasId, config) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            new Chart(ctx, {
                type: config.type || 'bar',
                data: config.data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: config.type === 'pie' || config.type === 'doughnut',
                            position: 'bottom'
                        }
                    },
                    scales: config.type !== 'pie' && config.type !== 'doughnut' ? {
                        y: { beginAtZero: true }
                    } : {}
                }
            });
        }

        function renderTable(columns, data) {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');

            // Ë°®Â§¥
            let headerHtml = '<tr>';
            columns.forEach(col => {
                headerHtml += `<th>${col}</th>`;
            });
            headerHtml += '</tr>';
            thead.innerHTML = headerHtml;

            // Ë°®‰Ωì
            renderTablePage(1);
        }

        function renderTablePage(page) {
            currentPage = page;
            const tbody = document.getElementById('tableBody');
            const start = (page - 1) * pageSize;
            const end = Math.min(start + pageSize, filteredData.length);
            const pageData = filteredData.slice(start, end);

            tbody.innerHTML = '';

            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="100" class="loading">ÊöÇÊó†Êï∞ÊçÆ</td></tr>';
                return;
            }

            pageData.forEach(row => {
                const tr = document.createElement('tr');
                Object.values(row).forEach(value => {
                    tr.innerHTML += `<td>${value !== null ? value : '-'}</td>`;
                });
                tbody.appendChild(tr);
            });

            // Êõ¥Êñ∞ÂàÜÈ°µ
            updatePagination();
        }

        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(filteredData.length / pageSize);

            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'flex';
            document.getElementById('pageInfo').textContent =
                `Á¨¨ ${currentPage} / ${totalPages} È°µÔºåÂÖ± ${filteredData.length} Êù°ËÆ∞ÂΩï`;

            const controls = document.getElementById('pageControls');
            controls.innerHTML = '';

            // ‰∏ä‰∏ÄÈ°µ
            const prevBtn = createPageBtn('‰∏ä‰∏ÄÈ°µ', currentPage - 1, currentPage === 1);
            controls.appendChild(prevBtn);

            // È°µÁ†Å
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                controls.appendChild(createPageBtn(i.toString(), i, false, i === currentPage));
            }

            // ‰∏ã‰∏ÄÈ°µ
            const nextBtn = createPageBtn('‰∏ã‰∏ÄÈ°µ', currentPage + 1, currentPage === totalPages);
            controls.appendChild(nextBtn);
        }

        function createPageBtn(text, page, disabled, active = false) {
            const btn = document.createElement('button');
            btn.className = 'page-btn';
            btn.textContent = text;
            btn.disabled = disabled;
            if (active) btn.classList.add('active');
            if (!disabled) {
                btn.onclick = () => renderTablePage(page);
            }
            return btn;
        }

        function showError(message) {
            document.querySelector('.container').innerHTML = `
                <div style="background: rgba(255,255,255,0.95); border-radius: 12px; padding: 60px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
                    <div style="color: #721c24; font-size: 18px; margin-bottom: 10px;">Âä†ËΩΩÂ§±Ë¥•</div>
                    <div style="color: #666;">${message}</div>
                </div>
            `;
        }
    </script>
</body>
</html>
